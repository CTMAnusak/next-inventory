/**
 * =========================================
 * SNAPSHOT HELPERS
 * =========================================
 * 
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á snapshot ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô RequestLog ‡πÅ‡∏•‡∏∞ ReturnLog
 * ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠ InventoryItem ‡∏´‡∏£‡∏∑‡∏≠ InventoryMaster ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö
 */

import InventoryItem from '@/models/InventoryItem';
import InventoryConfig from '@/models/InventoryConfig';

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á snapshot ‡∏Ç‡∏≠‡∏á InventoryItem ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô RequestLog
 */
export async function createInventoryItemSnapshot(itemId: string) {
  try {
    const inventoryItem = await InventoryItem.findById(itemId);
    
    if (!inventoryItem) {
      console.warn(`‚ö†Ô∏è InventoryItem not found: ${itemId}`);
      return null;
    }
    
    // Get configurations for names
    const config = await InventoryConfig.findOne({});
    const categoryConfigs = config?.categoryConfigs || [];
    const statusConfigs = config?.statusConfigs || [];
    const conditionConfigs = config?.conditionConfigs || [];
    
    const categoryConfig = categoryConfigs.find((c: any) => c.id === (inventoryItem as any).categoryId);
    const statusConfig = statusConfigs.find((s: any) => s.id === inventoryItem.statusId);
    const conditionConfig = conditionConfigs.find((c: any) => c.id === inventoryItem.conditionId);

    return { 
      itemId: itemId,
      itemName: (inventoryItem as any).itemName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
      categoryId: (inventoryItem as any).categoryId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
      categoryName: categoryConfig?.name || (inventoryItem as any).categoryId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
      serialNumber: inventoryItem.serialNumber || undefined,
      numberPhone: inventoryItem.numberPhone || undefined,
      statusId: inventoryItem.statusId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
      statusName: statusConfig?.name || inventoryItem.statusId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
      conditionId: inventoryItem.conditionId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
      conditionName: conditionConfig?.name || inventoryItem.conditionId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
    };
  } catch (error) {
    console.error(`‚ùå Error creating snapshot for item ${itemId}:`, error);
    return null;
  }
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á snapshot ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡πÜ items ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
 */
export async function createInventoryItemSnapshotsBatch(itemIds: string[]) {
  const snapshots = await Promise.all(
    itemIds.map(itemId => createInventoryItemSnapshot(itemId))
  );
  
  // Filter out null values
  return snapshots.filter(snapshot => snapshot !== null);
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á snapshot ‡∏à‡∏≤‡∏Å InventoryItem object ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î query)
 */
export async function createInventoryItemSnapshotFromObject(inventoryItem: any) {
  try {
    // Get configurations for names
    const config = await InventoryConfig.findOne({});
    const categoryConfigs = config?.categoryConfigs || [];
    const statusConfigs = config?.statusConfigs || [];
    const conditionConfigs = config?.conditionConfigs || [];
    
    const categoryConfig = categoryConfigs.find((c: any) => c.id === inventoryItem.categoryId);
    const statusConfig = statusConfigs.find((s: any) => s.id === inventoryItem.statusId);
    const conditionConfig = conditionConfigs.find((c: any) => c.id === inventoryItem.conditionId);
    
    return {
      itemId: inventoryItem._id.toString(),
      itemName: inventoryItem.itemName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
      categoryId: inventoryItem.categoryId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
      categoryName: categoryConfig?.name || inventoryItem.categoryId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
      serialNumber: inventoryItem.serialNumber || undefined,
      numberPhone: inventoryItem.numberPhone || undefined,
      statusId: inventoryItem.statusId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
      statusName: statusConfig?.name || inventoryItem.statusId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
      conditionId: inventoryItem.conditionId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
      conditionName: conditionConfig?.name || inventoryItem.conditionId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
    };
  } catch (error) {
    console.error(`‚ùå Error creating snapshot from object:`, error);
    return null;
  }
}

/**
 * =========================================
 * UPDATE SNAPSHOT BEFORE DELETE
 * =========================================
 * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï snapshot ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å RequestLog ‡∏ó‡∏µ‡πà‡∏°‡∏µ itemId ‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö
 * ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏ß‡πâ
 */
export async function updateSnapshotsBeforeDelete(itemId: string) {
  try {
    console.log(`\nüì∏ Updating snapshots before deleting item: ${itemId}`);
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á InventoryItem
    const inventoryItem = await InventoryItem.findById(itemId);
    
    if (!inventoryItem) {
      console.warn(`‚ö†Ô∏è InventoryItem not found: ${itemId}`);
      return { success: false, message: 'Item not found' };
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á snapshot ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    const latestSnapshot = await createInventoryItemSnapshotFromObject(inventoryItem);
    
    if (!latestSnapshot) {
      console.error(`‚ùå Failed to create snapshot for item: ${itemId}`);
      return { success: false, message: 'Failed to create snapshot' };
    }
    
    console.log(`üì∏ Created latest snapshot:`, latestSnapshot);
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï snapshot ‡πÉ‡∏ô RequestLog ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ itemId ‡∏ô‡∏µ‡πâ
    const RequestLog = (await import('@/models/RequestLog')).default;
    
    const requestLogs = await RequestLog.find({
      'items.assignedItemIds': itemId
    });
    
    console.log(`üìã Found ${requestLogs.length} RequestLogs with this item`);
    
    let updatedCount = 0;
    
    for (const requestLog of requestLogs) {
      let hasUpdates = false;
      
      for (const item of requestLog.items) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ item ‡∏ô‡∏µ‡πâ‡∏°‡∏µ itemId ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (item.assignedItemIds?.includes(itemId)) {
          // Initialize assignedItemSnapshots ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
          if (!item.assignedItemSnapshots) {
            (item as any).assignedItemSnapshots = [];
          }
          
          // ‡∏´‡∏≤ snapshot ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á itemId ‡∏ô‡∏µ‡πâ
          const existingSnapshotIndex = (item as any).assignedItemSnapshots.findIndex(
            (s: any) => s.itemId === itemId
          );
          
          if (existingSnapshotIndex >= 0) {
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï snapshot ‡πÄ‡∏î‡∏¥‡∏°
            (item as any).assignedItemSnapshots[existingSnapshotIndex] = latestSnapshot;
            console.log(`   ‚úÖ Updated existing snapshot for item in RequestLog ${requestLog._id}`);
          } else {
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° snapshot ‡πÉ‡∏´‡∏°‡πà
            (item as any).assignedItemSnapshots.push(latestSnapshot);
            console.log(`   ‚úÖ Added new snapshot for item in RequestLog ${requestLog._id}`);
          }
          
          hasUpdates = true;
        }
      }
      
      if (hasUpdates) {
        (requestLog as any).markModified('items');
        await requestLog.save();
        updatedCount++;
      }
    }
    
    console.log(`‚úÖ Updated ${updatedCount} RequestLogs with latest snapshot`);
    
    return {
      success: true,
      updatedRequestLogs: updatedCount,
      snapshot: latestSnapshot
    };
    
  } catch (error) {
    console.error(`‚ùå Error updating snapshots before delete:`, error);
    return {
      success: false,
      message: error instanceof Error ? error.message : 'Unknown error'
    };
  }
}

/**
 * =========================================
 * USER DELETION SNAPSHOT FUNCTIONS
 * =========================================
 * Snapshot ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
 */

/**
 * Snapshot ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö
 * ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°: IssueLog, RequestLog, ReturnLog, TransferLog
 */
export async function snapshotUserBeforeDelete(userId: string) {
  try {
    console.log(`üì∏ Starting snapshot for user ${userId}...`);
    
    // Import equipment snapshot helpers
    const { snapshotEquipmentLogsBeforeUserDelete } = await import('@/lib/equipment-snapshot-helpers');
    
    // Snapshot Equipment Logs (RequestLog, ReturnLog, TransferLog)
    const equipmentResults = await snapshotEquipmentLogsBeforeUserDelete(userId);
    
    // Snapshot IssueLog (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const issueResults = await snapshotIssueLogsBeforeUserDelete(userId);
    
    const totalModified = 
      equipmentResults.requestLogs.modifiedCount +
      equipmentResults.returnLogs.modifiedCount +
      equipmentResults.transferLogs.modifiedCount +
      issueResults.requester.modifiedCount +
      issueResults.admin.modifiedCount;
    
    console.log(`‚úÖ Snapshot completed for user ${userId}:`);
    console.log(`   - RequestLogs: ${equipmentResults.requestLogs.modifiedCount}`);
    console.log(`   - ReturnLogs: ${equipmentResults.returnLogs.modifiedCount}`);
    console.log(`   - TransferLogs: ${equipmentResults.transferLogs.modifiedCount}`);
    console.log(`   - IssueLogs (Requester): ${issueResults.requester.modifiedCount}`);
    console.log(`   - IssueLogs (Admin): ${issueResults.admin.modifiedCount}`);
    console.log(`   - Total: ${totalModified} records`);
    
    return {
      success: true,
      totalModified,
      equipment: equipmentResults,
      issues: issueResults
    };
    
  } catch (error) {
    console.error(`‚ùå Error snapshotting user ${userId}:`, error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error'
    };
  }
}

/**
 * Snapshot IssueLog ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö User
 * - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á (requesterName)
 * - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (assignedToName)
 */
async function snapshotIssueLogsBeforeUserDelete(userId: string) {
  try {
    const IssueLog = (await import('@/models/IssueLog')).default;
    const { getUserName } = await import('@/lib/equipment-snapshot-helpers');
    
    const userName = await getUserName(userId);
    
    // Snapshot as Requester
    const requesterResult = await IssueLog.updateMany(
      { requester: userId },
      { 
        $set: {
          requesterName: userName
        }
      }
    );
    
    // Snapshot as Admin (assignedTo)
    const adminResult = await IssueLog.updateMany(
      { assignedTo: userId },
      { 
        $set: {
          assignedToName: userName
        }
      }
    );
    
    console.log(`‚úÖ Snapshot IssueLogs (user: ${userId})`);
    console.log(`   - As Requester: ${requesterResult.modifiedCount}`);
    console.log(`   - As Admin: ${adminResult.modifiedCount}`);
    
    return {
      requester: { success: true, modifiedCount: requesterResult.modifiedCount },
      admin: { success: true, modifiedCount: adminResult.modifiedCount }
    };
    
  } catch (error) {
    console.error('Error snapshotting IssueLogs:', error);
    return {
      requester: { success: false, modifiedCount: 0, error },
      admin: { success: false, modifiedCount: 0, error }
    };
  }
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
export async function checkUserRelatedIssues(userId: string) {
  try {
    const IssueLog = (await import('@/models/IssueLog')).default;
    const RequestLog = (await import('@/models/RequestLog')).default;
    const ReturnLog = (await import('@/models/ReturnLog')).default;
    const TransferLog = (await import('@/models/TransferLog')).default;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö IssueLog
    const issueAsRequester = await IssueLog.countDocuments({ requester: userId });
    const issueAsAdmin = await IssueLog.countDocuments({ assignedTo: userId });
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö RequestLog
    const requestAsRequester = await RequestLog.countDocuments({ requester: userId });
    const requestAsApprover = await RequestLog.countDocuments({ approvedBy: userId });
    const requestAsRejecter = await RequestLog.countDocuments({ rejectedBy: userId });
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ReturnLog
    const returnAsReturner = await ReturnLog.countDocuments({ returner: userId });
    const returnAsApprover = await ReturnLog.countDocuments({ 'items.approvedBy': userId });
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö TransferLog
    const transferAsFrom = await TransferLog.countDocuments({ 'fromOwnership.userId': userId });
    const transferAsTo = await TransferLog.countDocuments({ 'toOwnership.userId': userId });
    const transferAsProcessor = await TransferLog.countDocuments({ processedBy: userId });
    const transferAsApprover = await TransferLog.countDocuments({ approvedBy: userId });
    
    const total = 
      issueAsRequester + issueAsAdmin +
      requestAsRequester + requestAsApprover + requestAsRejecter +
      returnAsReturner + returnAsApprover +
      transferAsFrom + transferAsTo + transferAsProcessor + transferAsApprover;
    
    return {
      total,
      hasRelatedIssues: total > 0,
      asRequester: issueAsRequester + requestAsRequester + returnAsReturner,
      asAdmin: issueAsAdmin + requestAsApprover + requestAsRejecter + returnAsApprover + transferAsProcessor + transferAsApprover,
      asTransferFrom: transferAsFrom,
      asTransferTo: transferAsTo
    };
    
  } catch (error) {
    console.error('Error checking user related issues:', error);
    return {
      total: 0,
      hasRelatedIssues: false,
      asRequester: 0,
      asAdmin: 0,
      asTransferFrom: 0,
      asTransferTo: 0,
      error
    };
  }
}