# ЁЯзк р╕Др╕╣р╣Ир╕бр╕╖р╕нр╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╕гр╕░р╕Ър╕Ъ Snapshot р╣Ар╕бр╕╖р╣Ир╕нр╕ер╕Ър╕кр╕▓р╕Вр╕▓

## р╕зр╕┤р╕Шр╕╡р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ

### 1. р╕Чр╕Фр╕кр╕нр╕Ър╕Фр╣Йр╕зр╕вр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤

```bash
node test-office-deletion-snapshot.js
```

р╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Ир╕░р╕Ир╕│р╕ер╕нр╕Зр╣Ар╕лр╕Хр╕╕р╕Бр╕▓р╕гр╕Ур╣М:
1. р╕кр╕гр╣Йр╕▓р╕Зр╕кр╕▓р╕Вр╕▓ "CTW"
2. р╕кр╕гр╣Йр╕▓р╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╣Бр╕ер╕░р╣Гр╕лр╣Йр╕нр╕вр╕╣р╣Ир╕кр╕▓р╕Вр╕▓ "CTW"
3. р╕Чр╕│р╕Бр╕▓р╕гр╣Ар╕Ър╕┤р╕Б-р╕Др╕╖р╕Щр╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣М (requesterOfficeId = "CTW")
4. р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕кр╕▓р╕Вр╕▓р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Ир╕▓р╕Б "CTW" тЖТ "Central Wategate"
5. р╕ер╕Ър╕кр╕▓р╕Вр╕▓ "Central Wategate"
6. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ snapshot = "Central Wategate" (р╣Др╕бр╣Ир╣Гр╕Кр╣И "CTW")

**р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Чр╕╡р╣Ир╕Др╕▓р╕Фр╕лр╕зр╕▒р╕З:**
```
тЬЕ RequestLog.requesterOffice = "Central Wategate"
тЬЕ ReturnLog.returnerOffice = "Central Wategate"
тЬЕ IssueLog.office = "Central Wategate"
тЬЕ User.office = "Central Wategate"
тЬЕ User.officeId = "UNSPECIFIED_OFFICE"
тЬЕ RequestLog.requesterOfficeId р╕вр╕▒р╕Зр╣Ар╕Ыр╣Зр╕Щ CTW (р╣Др╕бр╣Ир╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ)
тЬЕ ReturnLog.returnerOfficeId р╕вр╕▒р╕Зр╣Ар╕Ыр╣Зр╕Щ CTW (р╣Др╕бр╣Ир╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ)
```

---

### 2. р╕Чр╕Фр╕кр╕нр╕Ър╕Фр╣Йр╕зр╕вр╕Хр╕Щр╣Ар╕нр╕З (Manual Testing)

#### р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 1: р╕кр╕гр╣Йр╕▓р╕Зр╕кр╕▓р╕Вр╕▓р╣Гр╕лр╕бр╣И

1. р╣Ар╕Вр╣Йр╕▓р╕лр╕Щр╣Йр╕▓ `/admin/users`
2. р╕Др╕ер╕┤р╕Б "р╣Бр╕Бр╣Йр╣Др╕Вр╕кр╕▓р╕Вр╕▓"
3. р╕кр╕гр╣Йр╕▓р╕Зр╕кр╕▓р╕Вр╕▓р╣Гр╕лр╕бр╣Ир╕Кр╕╖р╣Ир╕н "CTW"

#### р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 2: р╕кр╕гр╣Йр╕▓р╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╣Гр╕лр╕бр╣И

1. р╕Др╕ер╕┤р╕Б "р╣Ар╕Юр╕┤р╣Ир╕бр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й"
2. р╕Бр╕гр╕нр╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕е:
   - р╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е: р╕зр╕▒р╕Тр╕Щр╣Мр╕Щр╕╡ р╣Гр╕Ир╕Фр╕╡
   - р╕кр╕▓р╕Вр╕▓: CTW
3. р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б

#### р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 3: р╕Чр╕│р╕Бр╕▓р╕гр╣Ар╕Ър╕┤р╕Б-р╕Др╕╖р╕Щр╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣М

1. Login р╕Фр╣Йр╕зр╕в user р╕зр╕▒р╕Тр╕Щр╣Мр╕Щр╕╡
2. р╣Ар╕Ър╕┤р╕Бр╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣М (р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З: Mouse Logitech)
3. Admin р╕нр╕Щр╕╕р╕бр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╣Ар╕Ър╕┤р╕Б
4. р╕Др╕╖р╕Щр╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣М
5. Admin р╕нр╕Щр╕╕р╕бр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕Др╕╖р╕Щ

**р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ:**
- р╣Ар╕Вр╣Йр╕▓р╕лр╕Щр╣Йр╕▓ `/admin/equipment-reports` тЖТ р╣Бр╕Чр╣Зр╕Ъ "р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╣Ар╕Ър╕┤р╕Б"
- р╕Др╕зр╕гр╣Ар╕лр╣Зр╕Щр╕кр╕▓р╕Вр╕▓ "CTW"

#### р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 4: р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕кр╕▓р╕Вр╕▓р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й

1. р╣Ар╕Вр╣Йр╕▓р╕лр╕Щр╣Йр╕▓ `/admin/users`
2. р╕Др╕ер╕┤р╕Б "р╣Бр╕Бр╣Йр╣Др╕Вр╕кр╕▓р╕Вр╕▓"
3. р╕кр╕гр╣Йр╕▓р╕Зр╕кр╕▓р╕Вр╕▓р╣Гр╕лр╕бр╣Ир╕Кр╕╖р╣Ир╕н "Central Wategate"
4. р╣Бр╕Бр╣Йр╣Др╕Вр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й р╕зр╕▒р╕Тр╕Щр╣Мр╕Щр╕╡ тЖТ р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕кр╕▓р╕Вр╕▓р╣Ар╕Ыр╣Зр╕Щ "Central Wategate"

**р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ:**
- р╣Ар╕Вр╣Йр╕▓р╕лр╕Щр╣Йр╕▓ `/admin/equipment-reports` тЖТ р╣Бр╕Чр╣Зр╕Ъ "р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╣Ар╕Ър╕┤р╕Б"
- р╕Др╕зр╕гр╕вр╕▒р╕Зр╣Ар╕лр╣Зр╕Щр╕кр╕▓р╕Вр╕▓ "CTW" (р╣Др╕бр╣Ир╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ)

#### р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 5: р╕ер╕Ър╕кр╕▓р╕Вр╕▓ "Central Wategate"

1. р╣Ар╕Вр╣Йр╕▓р╕лр╕Щр╣Йр╕▓ `/admin/users`
2. р╕Др╕ер╕┤р╕Б "р╣Бр╕Бр╣Йр╣Др╕Вр╕кр╕▓р╕Вр╕▓"
3. р╕ер╕Ър╕кр╕▓р╕Вр╕▓ "Central Wategate"
4. р╕Юр╕┤р╕бр╕Юр╣М "delete" р╣Ар╕Юр╕╖р╣Ир╕нр╕вр╕╖р╕Щр╕вр╕▒р╕Щ

**р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М:**

1. **р╕лр╕Щр╣Йр╕▓ `/admin/users`:**
   - р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й р╕зр╕▒р╕Тр╕Щр╣Мр╕Щр╕╡ р╕Др╕зр╕гр╣Бр╕кр╕Фр╕Зр╕кр╕▓р╕Вр╕▓ "р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕р╕кр╕▓р╕Вр╕▓"

2. **р╕лр╕Щр╣Йр╕▓ `/admin/equipment-reports` тЖТ р╣Бр╕Чр╣Зр╕Ъ "р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╣Ар╕Ър╕┤р╕Б":**
   - тЬЕ р╕Др╕зр╕гр╣Бр╕кр╕Фр╕Зр╕кр╕▓р╕Вр╕▓ "Central Wategate" (р╣Др╕бр╣Ир╣Гр╕Кр╣И "CTW")
   - тЬЕ р╣Др╕бр╣Ир╕Др╕зр╕гр╣Бр╕кр╕Фр╕З "р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕р╕кр╕▓р╕Вр╕▓"

3. **р╕лр╕Щр╣Йр╕▓ `/admin/equipment-reports` тЖТ р╣Бр╕Чр╣Зр╕Ъ "р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Др╕╖р╕Щ":**
   - тЬЕ р╕Др╕зр╕гр╣Бр╕кр╕Фр╕Зр╕кр╕▓р╕Вр╕▓ "Central Wategate" (р╣Др╕бр╣Ир╣Гр╕Кр╣И "CTW")
   - тЬЕ р╣Др╕бр╣Ир╕Др╕зр╕гр╣Бр╕кр╕Фр╕З "р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕р╕кр╕▓р╕Вр╕▓"

4. **р╕лр╕Щр╣Йр╕▓ `/it-tracking` (р╕Цр╣Йр╕▓р╕бр╕╡р╕гр╕▓р╕вр╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╕Ыр╕▒р╕Нр╕лр╕▓):**
   - тЬЕ р╕Др╕зр╕гр╣Бр╕кр╕Фр╕Зр╕кр╕▓р╕Вр╕▓ "Central Wategate"
   - тЬЕ р╣Др╕бр╣Ир╕Др╕зр╕гр╣Бр╕кр╕Фр╕З "р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕р╕кр╕▓р╕Вр╕▓"

---

## ЁЯУК р╕Хр╕▓р╕гр╕▓р╕Зр╣Ар╕Ыр╕гр╕╡р╕вр╕Ър╣Ар╕Чр╕╡р╕вр╕Ър╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М

| р╕Ир╕╕р╕Фр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ | р╕Бр╣Ир╕нр╕Щр╣Бр╕Бр╣Йр╣Др╕В | р╕лр╕ер╕▒р╕Зр╣Бр╕Бр╣Йр╣Др╕В (р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З) |
|------------|-----------|---------------------|
| RequestLog.requesterOffice | "CTW" тЭМ | "Central Wategate" тЬЕ |
| ReturnLog.returnerOffice | "CTW" тЭМ | "Central Wategate" тЬЕ |
| IssueLog.office | "р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕р╕кр╕▓р╕Вр╕▓" тЭМ | "Central Wategate" тЬЕ |
| User.office | "Central Wategate" тЬЕ | "Central Wategate" тЬЕ |
| User.officeId | UNSPECIFIED_OFFICE тЬЕ | UNSPECIFIED_OFFICE тЬЕ |
| RequestLog.requesterOfficeId | CTW (р╣Ар╕Фр╕┤р╕б) тЬЕ | CTW (р╣Ар╕Фр╕┤р╕б) тЬЕ |

---

## ЁЯФН р╕Бр╕▓р╕г Debug

### 1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ Snapshot р╕Чр╕│р╕Зр╕▓р╕Щр╕лр╕гр╕╖р╕нр╣Др╕бр╣И

р╣Ар╕Ыр╕┤р╕Ф Terminal р╣Бр╕ер╕░р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ console log:

```
ЁЯУ╕ Found 1 users with office "Central Wategate"
ЁЯУ╕ Snapshot Office "Central Wategate" completed: {
  users: 1,
  requestLogs: 2,
  returnLogs: 1,
  issueLogs: 1,
  inventoryItems: 0,
  deletedUsers: 0
}
```

### 2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щ Database

```javascript
// р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ RequestLog
db.requestlogs.find({ userId: "USER_ID" }, { 
  requesterOffice: 1, 
  requesterOfficeId: 1, 
  userId: 1 
})

// р╕Др╕зр╕гр╣Др╕Фр╣Й:
{
  requesterOffice: "Central Wategate",
  requesterOfficeId: "CTW_OFFICE_ID",
  userId: "USER_ID"
}
```

### 3. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ Populate р╕Чр╕│р╕Зр╕▓р╕Щр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З

р╣Ар╕Ыр╕┤р╕Ф DevTools тЖТ Network тЖТ р╕Фр╕╣ Response р╕Ир╕▓р╕Б API:

```json
{
  "items": [{
    "office": "Central Wategate",
    "officeId": "CTW_OFFICE_ID"
  }]
}
```

---

## тЭМ р╕Ыр╕▒р╕Нр╕лр╕▓р╕Чр╕╡р╣Ир╕нр╕▓р╕Ир╕Юр╕Ъ

### р╕Ыр╕▒р╕Нр╕лр╕▓ 1: р╣Бр╕кр╕Фр╕Зр╕кр╕▓р╕Вр╕▓р╣Ар╕Фр╕┤р╕б "CTW" р╣Бр╕Чр╕Щ "Central Wategate"

**р╕кр╕▓р╣Ар╕лр╕Хр╕╕:** Snapshot р╣Др╕бр╣Ир╕Чр╕│р╕Зр╕▓р╕Щ р╕лр╕гр╕╖р╕н р╕Чр╕│р╕Зр╕▓р╕Щр╣Др╕бр╣Ир╕Др╕гр╕Ъ

**р╕зр╕┤р╕Шр╕╡р╣Бр╕Бр╣Й:**
1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ `snapshotOfficeBeforeDelete()` р╕Цр╕╣р╕Бр╣Ар╕гр╕╡р╕вр╕Бр╕Бр╣Ир╕нр╕Щр╕ер╕Ъ
2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ query р╣Гр╕Кр╣Й `$or` р╣Ар╕Юр╕╖р╣Ир╕н snapshot р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й

### р╕Ыр╕▒р╕Нр╕лр╕▓ 2: р╣Бр╕кр╕Фр╕З "р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕р╕кр╕▓р╕Вр╕▓"

**р╕кр╕▓р╣Ар╕лр╕Хр╕╕:** Populate logic р╣Др╕бр╣Ир╣Др╕Фр╣Йр╣Гр╕Кр╣Й snapshot

**р╕зр╕┤р╕Шр╕╡р╣Бр╕Бр╣Й:**
1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ populate functions р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ `requesterOfficeId` р╕Бр╣Ир╕нр╕Щ
2. р╕Цр╣Йр╕▓ `requesterOfficeId` != `UNSPECIFIED_OFFICE` р╕Др╕зр╕гр╣Гр╕Кр╣Й snapshot р╕Ир╕▓р╕Б `requesterOffice`

### р╕Ыр╕▒р╕Нр╕лр╕▓ 3: Snapshot р╣Ар╕Йр╕Юр╕▓р╕░р╕Ър╕▓р╕Зр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤

**р╕кр╕▓р╣Ар╕лр╕Хр╕╕:** Query р╣Др╕бр╣Ир╣Др╕Фр╣Й snapshot р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й

**р╕зр╕┤р╕Шр╕╡р╣Бр╕Бр╣Й:**
1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ `snapshotOfficeBeforeDelete()` р╕лр╕▓ `userId` р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╕кр╕▓р╕Вр╕▓р╕Щр╕╡р╣Й
2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ query р╣Гр╕Кр╣Й `$or: [{ officeId }, { userId: { $in: userIds } }]`

---

## тЬЕ Checklist р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ

- [ ] Snapshot р╕Чр╕│р╕Зр╕▓р╕Щр╣Ар╕бр╕╖р╣Ир╕нр╕ер╕Ър╕кр╕▓р╕Вр╕▓
- [ ] Snapshot р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣Ир╕кр╕▓р╕Вр╕▓р╕Щр╕╡р╣Й
- [ ] р╕лр╕Щр╣Йр╕▓ `/admin/equipment-reports` тЖТ р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╣Ар╕Ър╕┤р╕Б р╣Бр╕кр╕Фр╕Зр╕кр╕▓р╕Вр╕▓р╕ер╣Ир╕▓р╕кр╕╕р╕Ф
- [ ] р╕лр╕Щр╣Йр╕▓ `/admin/equipment-reports` тЖТ р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Др╕╖р╕Щ р╣Бр╕кр╕Фр╕Зр╕кр╕▓р╕Вр╕▓р╕ер╣Ир╕▓р╕кр╕╕р╕Ф
- [ ] р╕лр╕Щр╣Йр╕▓ `/it-tracking` р╣Бр╕кр╕Фр╕Зр╕кр╕▓р╕Вр╕▓р╕ер╣Ир╕▓р╕кр╕╕р╕Ф
- [ ] р╣Др╕бр╣Ир╣Бр╕кр╕Фр╕З "р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕р╕кр╕▓р╕Вр╕▓" р╣Гр╕Щр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Чр╕╡р╣Ир╕бр╕╡ snapshot
- [ ] User.officeId р╣Ар╕Ыр╣Зр╕Щ UNSPECIFIED_OFFICE р╕лр╕ер╕▒р╕Зр╕ер╕Ър╕кр╕▓р╕Вр╕▓
- [ ] RequestLog.requesterOfficeId р╕вр╕▒р╕Зр╣Ар╕Ыр╣Зр╕Щр╣Ар╕Фр╕┤р╕б (р╣Др╕бр╣Ир╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ)

